import React, { useState, useCallback, useMemo } from 'react';

/**
 * 2026년 대한민국 법정 공휴일 및 대체 공휴일 데이터 (내장형)
 * 제공된 2026_korea_holidays.md 파일을 기반으로 작성됨
 */
const HOLIDAYS_2026 = {
  0: [1],             // 1월: 신정
  1: [16, 17, 18],    // 2월: 설날 연휴
  2: [1, 2],          // 3월: 삼일절, 대체 공휴일
  3: [],              // 4월: 없음
  4: [5, 24, 25],     // 5월: 어린이날, 부처님 오신 날, 대체 공휴일
  5: [6],             // 6월: 현충일
  6: [],              // 7월: 없음
  7: [15, 17],        // 8월: 광복절, 대체 공휴일
  8: [24, 25, 26, 28], // 9월: 추석 연휴, 대체 공휴일
  9: [3, 5, 9],       // 10월: 개천절, 대체 공휴일, 한글날
  10: [],             // 11월: 없음
  11: [25]            // 12월: 성탄절
};

const Icon = ({ name, size = 20, className = "" }) => {
  const icons = {
    trees: "m12 19 3-7 3 7h-6Z M9 19 12 12 15 19H9Z M6 19 9 12 12 19H6Z",
    calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
    rain: "M8 19c-2.8 0-5-2.2-5-5s2.2-5 5-5c.4 0 .9.1 1.3.2A6 6 0 0 1 20 12c0 3.3-2.7 6-6 6h-6z M10 21v2 M14 21v2",
    info: "M12 16v-4M12 8h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10z",
    chevron: "m9 18 6-6-6-6",
    external: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"
  };
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
      <path d={icons[name] || ""} />
      {name === 'trees' && <path d="M12 19v3" />}
    </svg>
  );
};

export default function App() {
  const [monthIndex, setMonthIndex] = useState(new Date().getMonth());
  const [rainyInput, setRainyInput] = useState("");
  const [personalExclusions, setPersonalExclusions] = useState("");
  const [schedule, setSchedule] = useState(null);
  const [error, setError] = useState(null);

  const monthNames = [
    "1월 (January)", "2월 (February)", "3월 (March)", "4월 (April)", 
    "5월 (May)", "6월 (June)", "7월 (July)", "8월 (August)", 
    "9월 (September)", "10월 (October)", "11월 (November)", "12월 (December)"
  ];

  const currentMonthHolidays = useMemo(() => HOLIDAYS_2026[monthIndex] || [], [monthIndex]);

  // 특정 날짜의 요일을 반환하는 헬퍼 함수
  const getDayOfWeek = (day) => {
    const days = ['일', '월', '화', '수', '목', '금', '토'];
    const dateObj = new Date(2026, monthIndex, day);
    return days[dateObj.getDay()];
  };

  // 일정 생성 로직
  const generateSchedule = useCallback(() => {
    try {
      setError(null);
      const year = 2026;
      const month = monthIndex;
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const parseDays = (str) => str.split(/[,.\s]+/).map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d >= 1 && d <= 31);
      
      const rainSet = new Set(parseDays(rainyInput));
      const holidaySet = new Set(currentMonthHolidays);
      const personalSet = new Set(parseDays(personalExclusions));

      // 방문 가능한 평일 추출
      const availableDays = [];
      for (let d = 1; d <= daysInMonth; d++) {
        const dObj = new Date(year, month, d);
        const dayOfWeek = dObj.getDay(); // 0: Sun, 6: Sat
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        if (!isWeekend && !rainSet.has(d) && !holidaySet.has(d) && !personalSet.has(d)) {
          availableDays.push(d);
        }
      }

      if (availableDays.length < 5) {
        setError("방문 가능한 평일이 너무 부족합니다. 제외 일정을 조정해 주세요.");
        return;
      }

      const clients = [
        { id: 'austria', name: '오스트리아 (Austria)', count: 2 },
        { id: 'sweden', name: '스웨덴 (Sweden)', count: 2 },
        { id: 'norway', name: '노르웨이 (Norway)', count: (month + 1 >= 3 && month + 1 <= 11) ? 2 : 0 }
      ];

      const result = {};
      clients.forEach(client => {
        if (client.count === 0) {
          result[client.id] = [];
          return;
        }

        const picked = [];
        // 1회차: 가급적 월 전반부(1~15일)에서 선택
        const firstHalfOptions = availableDays.filter(d => d <= 15);
        const first = firstHalfOptions.length > 0 
          ? firstHalfOptions[Math.floor(Math.random() * firstHalfOptions.length)] 
          : availableDays[0];
        picked.push(first);
        
        // 2회차: 1차 방문 후 7~21일 사이에서 선택
        const secondHalfOptions = availableDays.filter(d => d >= first + 7 && d <= first + 21);
        if (secondHalfOptions.length > 0) {
          picked.push(secondHalfOptions[Math.floor(Math.random() * secondHalfOptions.length)]);
        } else {
          // 범위 내에 가능한 날이 없으면 그 이후 가장 빠른 날 선택
          const fallback = availableDays.filter(d => d > first);
          if (fallback.length > 0) picked.push(fallback[0]);
        }
        result[client.id] = picked.sort((a, b) => a - b);
      });

      setSchedule(result);
    } catch (e) {
      setError("일정 계산 중 오류가 발생했습니다.");
    }
  }, [monthIndex, rainyInput, personalExclusions, currentMonthHolidays]);

  return (
    <div className="min-h-screen p-4 md:p-8 flex flex-col items-center bg-stone-50 text-slate-900 font-sans">
      <div className="max-w-4xl w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-stone-200">
        
        {/* Header */}
        <div className="bg-emerald-900 p-8 md:p-10 text-white relative border-b-8 border-emerald-500">
          <div className="absolute top-0 right-0 p-8 opacity-5 pointer-events-none">
            <Icon name="trees" size={180} />
          </div>
          <div className="relative z-10 flex items-center gap-6">
            <div className="bg-emerald-500 p-4 rounded-3xl shadow-xl shadow-emerald-500/20">
              <Icon name="calendar" size={32} className="text-white" />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tight leading-none uppercase italic">2026 Gardening Scheduler</h1>
              <p className="text-emerald-400/80 text-sm font-bold tracking-[0.2em] mt-2 uppercase">Seongbuk-dong Management v5.1</p>
            </div>
          </div>
        </div>

        {/* Input Controls */}
        <div className="p-6 md:p-10 space-y-8 bg-white">
          <div className="flex flex-col md:flex-row items-center justify-between gap-6">
            {/* Month Control */}
            <div className="flex-1 flex items-center justify-between bg-stone-100 p-2 rounded-2xl border border-stone-200 shadow-inner w-full">
              <button 
                onClick={() => { setMonthIndex(prev => (prev > 0 ? prev - 1 : 0)); setSchedule(null); }}
                className="p-4 hover:bg-white rounded-xl transition-all font-black text-stone-400 hover:text-emerald-600 active:scale-90"
              >
                <Icon name="chevron" className="rotate-180" />
              </button>
              <span className="text-2xl font-black tabular-nums tracking-tighter">2026년 {monthNames[monthIndex]}</span>
              <button 
                onClick={() => { setMonthIndex(prev => (prev < 11 ? prev + 1 : 11)); setSchedule(null); }}
                className="p-4 hover:bg-white rounded-xl transition-all font-black text-stone-400 hover:text-emerald-600 active:scale-90"
              >
                <Icon name="chevron" />
              </button>
            </div>
            
            {/* Weather Link */}
            <a 
              href={`https://www.accuweather.com/ko/kr/seongbuk-dong/226016/${monthNames[monthIndex].split(' ')[1].toLowerCase().replace('(', '').replace(')', '')}-weather/226016?year=2026`}
              target="_blank" 
              rel="noopener noreferrer"
              className="flex-1 flex items-center justify-center gap-3 py-5 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black transition-all shadow-lg active:scale-95 group w-full"
            >
              <Icon name="rain" size={20} className="group-hover:rotate-12 transition-transform" />
              성북동 날씨 확인
            </a>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="text-[11px] font-black text-stone-500 ml-2 uppercase tracking-widest flex items-center gap-2">
                <Icon name="rain" size={14} className="text-blue-500" /> Rain (비 오는 날짜 입력)
              </label>
              <input 
                type="text" 
                value={rainyInput} 
                onChange={e => setRainyInput(e.target.value)} 
                placeholder="예: 5, 12, 13" 
                className="w-full p-5 rounded-2xl border-2 border-stone-100 focus:border-emerald-500 outline-none transition-all bg-stone-50 font-bold placeholder:text-zinc-300 shadow-inner"
              />
            </div>
            <div className="space-y-2">
              <label className="text-[11px] font-black text-stone-500 ml-2 uppercase tracking-widest flex items-center gap-2">
                <Icon name="info" size={14} className="text-amber-500" /> Personal (개인 일정 등 제외일)
              </label>
              <input 
                type="text" 
                value={personalExclusions} 
                onChange={e => setPersonalExclusions(e.target.value)} 
                placeholder="예: 3, 20" 
                className="w-full p-5 rounded-2xl border-2 border-stone-100 focus:border-emerald-500 outline-none transition-all bg-stone-50 font-bold placeholder:text-zinc-300 shadow-inner"
              />
            </div>
          </div>

          <button 
            onClick={generateSchedule}
            className="w-full py-6 bg-slate-900 hover:bg-black text-white rounded-3xl font-black text-xl transition-all shadow-2xl active:scale-[0.98] flex items-center justify-center gap-4 border-b-4 border-slate-700"
          >
            가드닝 일정 생성하기
          </button>

          {error && (
            <div className="p-6 bg-rose-50 text-rose-600 rounded-3xl border border-rose-100 font-bold text-sm flex items-center gap-3 animate-in fade-in slide-in-from-top-2">
              <Icon name="info" size={18} /> {error}
            </div>
          )}
        </div>

        {/* Results Area */}
        <div className="p-6 md:p-10 bg-stone-50 border-t border-stone-200 min-h-[450px]">
          {/* Internal Data Indicator */}
          {currentMonthHolidays.length > 0 && (
            <div className="mb-8 p-4 bg-rose-50/50 rounded-2xl border border-rose-100 flex items-center gap-3">
              <div className="text-rose-500"><Icon name="calendar" size={16} /></div>
              <p className="text-[11px] font-bold text-rose-700 uppercase tracking-widest">
                2026년 {monthIndex + 1}월 내장 공휴일: <span className="underline">{currentMonthHolidays.join(', ')}일</span>
              </p>
            </div>
          )}

          {!schedule ? (
            <div className="text-center py-28 opacity-10 flex flex-col items-center select-none pointer-events-none">
              <Icon name="trees" size={100} className="mb-6" />
              <p className="text-4xl font-black tracking-widest uppercase italic leading-none">System Standby</p>
              <p className="text-xs font-bold mt-4 uppercase tracking-[0.2em]">Enter rainy days to start</p>
            </div>
          ) : (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-6 duration-500">
              {[
                { id: 'austria', name: '오스트리아', desc: 'Austria Care Program', color: 'bg-rose-50 text-rose-800 border-rose-200' },
                { id: 'sweden', name: '스웨덴', desc: 'Sweden Care Program', color: 'bg-amber-50 text-amber-800 border-amber-200' },
                { id: 'norway', name: '노르웨이', desc: 'Norway Care Program', color: 'bg-sky-50 text-sky-800 border-sky-200' }
              ].map(c => (
                <div key={c.id} className={`p-8 rounded-[3rem] border-2 ${c.color} flex flex-col md:flex-row md:items-center justify-between gap-10 transition-all hover:translate-y-[-4px] hover:shadow-xl shadow-md`}>
                  <div className="flex items-center gap-6">
                    <div className="bg-white/80 p-5 rounded-[1.75rem] shadow-sm"><Icon name="trees" size={32} /></div>
                    <div>
                      <h3 className="text-4xl font-black tracking-tighter leading-none">{c.name}</h3>
                      <p className="text-[11px] font-black uppercase opacity-40 tracking-[0.3em] mt-2 italic">{c.desc}</p>
                    </div>
                  </div>
                  <div className="flex gap-4">
                    {c.id === 'norway' && (monthIndex + 1 < 3 || monthIndex + 1 > 11) ? (
                      <span className="text-slate-400 font-black italic bg-white/40 px-12 py-8 rounded-[2.5rem] border-2 border-dashed border-zinc-200 text-sm uppercase tracking-widest">Winter Break (No Visit)</span>
                    ) : schedule[c.id].length > 0 ? schedule[c.id].map((day, i) => (
                      <div key={i} className="bg-white px-8 py-6 rounded-[2.5rem] shadow-xl flex flex-col items-center border border-inherit border-opacity-30 min-w-[150px]">
                        <span className="text-[11px] opacity-20 mb-2 font-black tracking-[0.2em] uppercase">{i + 1}회차</span>
                        <div className="flex items-baseline gap-2">
                          <span className="text-6xl font-black">{day}</span>
                          <span className="text-2xl font-bold opacity-60">({getDayOfWeek(day)})</span>
                        </div>
                      </div>
                    )) : (
                      <span className="text-slate-400 font-black italic bg-white/40 px-10 py-7 rounded-[2rem] text-sm uppercase tracking-widest">Schedule Error</span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
      
      <footer className="mt-12 text-stone-400 text-[10px] font-black tracking-[0.5em] uppercase opacity-50 text-center leading-loose">
        Premium Garden Management Dashboard<br/>
        Internal Calendar Data Loaded • Optimized for 2026 Season
      </footer>
    </div>
  );
}
