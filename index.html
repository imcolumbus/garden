import React, { useState, useEffect, useCallback } from 'react';

// 시스템 환경에서 apiKey는 런타임에 주입됩니다.
const apiKey = ""; 

const Icon = ({ name, size = 20, className = "" }) => {
    const icons = {
        bot: "M12 8V4m0 0H8m4 0h4m-4 12v4m0 0h-4m4 0h4M4 12h4m8 0h4M6.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM17.5 11a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM6.5 11a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM17.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z",
        trees: "m12 19 3-7 3 7h-6Z M9 19 12 12 15 19H9Z M6 19 9 12 12 19H6Z",
        cloud: "M17.5 19c.3 0 .5 0 .8-.1a5 5 0 0 0 .7-9.6 7 7 0 0 0-13.5 1.7A4 4 0 0 0 2 15c0 2.2 1.8 4 4 4h11.5z",
        calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
        check: "M20 6L9 17l-5-5",
        sync: "M21 12a9 9 0 1 1-9-9c2.5 0 4.8 1 6.4 2.6L21 8m0-5v5h-5",
        edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
    };
    return (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d={icons[name] || ""} />
            {(name === 'bot' || name === 'trees') && <path d="M12 19v3" />}
        </svg>
    );
};

export default function App() {
    const [date, setDate] = useState(new Date(2026, 2, 1)); // 기본 2026년 3월
    const [rainyDays, setRainyDays] = useState([]);
    const [holidays, setHolidays] = useState([]);
    const [personalExclusions, setPersonalExclusions] = useState("");
    const [loading, setLoading] = useState(false);
    const [status, setStatus] = useState("");
    const [schedule, setSchedule] = useState(null);
    const [sources, setSources] = useState([]);
    const [error, setError] = useState(null);
    const [isManualMode, setIsManualMode] = useState(false);

    const generateSchedule = useCallback((rains, hols) => {
        try {
            const year = date.getFullYear();
            const month = date.getMonth();
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            const personalSet = new Set(personalExclusions.split(/[,.\s]+/).map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d > 0));
            const rainSet = new Set(rains.map(Number).filter(d => !isNaN(d)));
            const holidaySet = new Set(hols.map(Number).filter(d => !isNaN(d)));

            const available = [];
            for (let d = 1; d <= lastDay; d++) {
                const dObj = new Date(year, month, d);
                const isWeekend = dObj.getDay() === 0 || dObj.getDay() === 6;
                if (!isWeekend && !rainSet.has(d) && !holidaySet.has(d) && !personalSet.has(d)) {
                    available.push(d);
                }
            }

            if (available.length < 4) {
                setError("방문 가능한 평일이 부족합니다. 제외 일정을 줄이거나 수동 모드로 조정해 보세요.");
                return;
            }

            const clients = [
                { id: 'austria', name: '오스트리아', count: 2 },
                { id: 'sweden', name: '스웨덴', count: 2 },
                { id: 'norway', name: '노르웨이', count: (month + 1 >= 3 && month + 1 <= 11) ? 2 : 0 }
            ];

            const result = {};
            clients.forEach(c => {
                if (c.count === 0) { result[c.id] = []; return; }
                const chosen = [];
                const early = available.filter(d => d <= 15);
                const first = early.length > 0 ? early[Math.floor(Math.random() * early.length)] : available[0];
                chosen.push(first);
                
                const late = available.filter(d => d >= first + 7 && d <= first + 21);
                if (late.length > 0) chosen.push(late[Math.floor(Math.random() * late.length)]);
                else {
                    const next = available.filter(d => d > first);
                    if (next.length > 0) chosen.push(next[0]);
                }
                result[c.id] = chosen.sort((a,b) => a-b);
            });
            setSchedule(result);
            setError(null);
        } catch (e) {
            setError("스케줄 생성 중 오류가 발생했습니다.");
        }
    }, [date, personalExclusions]);

    const syncData = async (targetDate) => {
        setLoading(true);
        setError(null);
        setSchedule(null);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        
        const query = `성북동 ${year}년 ${month}월 날씨 정보를 검색하여 강수 확률이 높은 날짜(비 또는 눈)와 한국의 해당 월 공휴일을 찾아주세요. 반드시 JSON 형식 {"rainyDays": [숫자], "holidays": [숫자]}로만 답변하세요.`;

        const delays = [1000, 2000, 4000, 8000, 16000];
        
        for (let attempt = 0; attempt <= 5; attempt++) {
            try {
                setStatus(attempt === 0 ? "데이터 분석 시작..." : `재시도 중... (${attempt}/5)`);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        tools: [{ google_search: {} }],
                        systemInstruction: {
                            parts: [{ text: "당신은 정원관리 비서입니다. 검색을 통해 정확한 날짜를 찾아 JSON 데이터만 반환하세요. { \"rainyDays\": [], \"holidays\": [] } 형식을 지키고 다른 말은 하지 마세요." }]
                        },
                        generationConfig: { 
                            responseMimeType: "application/json"
                        }
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const resJson = await response.json();
                const resultText = resJson.candidates?.[0]?.content?.parts?.[0]?.text;
                const metaSources = resJson.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({
                    title: a.web?.title,
                    uri: a.web?.uri
                })) || [];

                if (resultText) {
                    const cleanedText = resultText.match(/\{[\s\S]*\}/)?.[0] || resultText;
                    const parsed = JSON.parse(cleanedText);
                    
                    setRainyDays(parsed.rainyDays || []);
                    setHolidays(parsed.holidays || []);
                    setSources(metaSources);
                    generateSchedule(parsed.rainyDays || [], parsed.holidays || []);
                    
                    setLoading(false);
                    setStatus("");
                    setIsManualMode(false);
                    return;
                }
            } catch (err) {
                console.error(`Attempt ${attempt} error:`, err);
                if (attempt === 5) {
                    setError("자동 수집이 원활하지 않습니다. 수동 모드에서 날짜를 입력해 주세요.");
                    setIsManualMode(true);
                } else {
                    await new Promise(r => setTimeout(r, delays[attempt]));
                }
            }
        }
        setLoading(false);
        setStatus("");
    };

    const handleManualSubmit = () => {
        const rains = rainyDays.toString().split(/[,.\s]+/).map(Number).filter(d => !isNaN(d) && d > 0);
        const hols = holidays.toString().split(/[,.\s]+/).map(Number).filter(d => !isNaN(d) && d > 0);
        generateSchedule(rains, hols);
    };

    const changeMonth = (offset) => {
        const next = new Date(date);
        next.setMonth(next.getMonth() + offset);
        setDate(next);
        setSchedule(null);
        setRainyDays([]);
        setHolidays([]);
    };

    return (
        <div className="min-h-screen p-4 md:p-12 flex flex-col items-center bg-slate-50 font-pretendard">
            <div className="max-w-4xl w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
                {/* Header */}
                <div className="bg-slate-900 p-10 text-white relative border-b-8 border-emerald-500">
                    <div className="flex items-center gap-5 relative z-10">
                        <div className="bg-emerald-500 p-4 rounded-3xl shadow-xl shadow-emerald-500/20">
                            <Icon name="bot" size={32} className="text-white" />
                        </div>
                        <div>
                            <h1 className="text-3xl font-black tracking-tighter uppercase italic">Garden Smart Planner</h1>
                            <p className="text-emerald-400/70 text-sm font-bold tracking-[0.3em] mt-1">DATA SYNC & AUTO PLAN v3.2</p>
                        </div>
                    </div>
                </div>

                {/* Controls */}
                <div className="p-8 md:p-10 space-y-8">
                    <div className="flex flex-col md:flex-row gap-6">
                        <div className="flex-1 space-y-6">
                            <div className="flex items-center justify-between bg-slate-50 p-2 rounded-2xl border border-slate-200 shadow-inner">
                                <button onClick={() => changeMonth(-1)} className="px-5 py-3 font-black text-slate-400 hover:text-slate-900 transition-colors active:scale-90">이전</button>
                                <span className="text-2xl font-black tabular-nums">{date.getFullYear()}년 {date.getMonth() + 1}월</span>
                                <button onClick={() => changeMonth(1)} className="px-5 py-3 font-black text-slate-400 hover:text-slate-900 transition-colors active:scale-90">다음</button>
                            </div>
                            
                            <button 
                                onClick={() => syncData(date)} 
                                disabled={loading}
                                className="w-full py-5 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-200 text-white rounded-3xl font-black text-lg shadow-xl flex items-center justify-center gap-3 transition-all active:scale-95 shadow-emerald-900/10"
                            >
                                {loading ? <Icon name="sync" className="animate-spin" /> : <Icon name="sync" />}
                                {loading ? status : "AI 정보 자동 가져오기"}
                            </button>
                        </div>

                        <div className="flex-1 space-y-4">
                            <div className="space-y-1">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Personal (개인 일정 제외일)</label>
                                <input 
                                    type="text" 
                                    value={personalExclusions} 
                                    onChange={e => setPersonalExclusions(e.target.value)} 
                                    placeholder="예: 3, 24, 25" 
                                    className="w-full p-4 rounded-2xl border-2 border-slate-50 focus:border-emerald-500 outline-none transition-all font-bold bg-slate-50 shadow-inner"
                                />
                            </div>
                            <div className={`p-4 rounded-2xl border flex items-start gap-3 transition-colors ${isManualMode ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-100'}`}>
                                <Icon name={isManualMode ? 'edit' : 'check'} size={16} className={isManualMode ? 'text-amber-600 mt-1' : 'text-emerald-600 mt-1'} />
                                <p className={`text-xs font-semibold leading-relaxed italic ${isManualMode ? 'text-amber-800' : 'text-emerald-800'}`}>
                                    {isManualMode ? "자동화 실패 시 수동으로 날짜를 입력하고 '수동 일정 생성'을 클릭하세요." : "AI가 날씨와 공휴일을 자동으로 확인합니다. 비 오는 날을 직접 수정할 수도 있습니다."}
                                </p>
                            </div>
                        </div>
                    </div>

                    {isManualMode && (
                        <div className="grid grid-cols-2 gap-4 animate-slide-up">
                            <div className="space-y-1">
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">비 오는 날 (우천일)</label>
                                <input type="text" value={rainyDays} onChange={e => setRainyDays(e.target.value)} placeholder="예: 5, 12, 13" className="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white shadow-sm font-bold" />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">공휴일 (빨간 날)</label>
                                <input type="text" value={holidays} onChange={e => setHolidays(e.target.value)} placeholder="예: 1, 15" className="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white shadow-sm font-bold" />
                            </div>
                            <button onClick={handleManualSubmit} className="col-span-2 py-4 bg-slate-800 text-white font-black rounded-2xl hover:bg-slate-700 transition-all">수동 일정 생성</button>
                        </div>
                    )}

                    {error && (
                        <div className="p-5 bg-rose-50 text-rose-600 rounded-3xl border border-rose-100 font-bold text-sm flex items-start gap-3">
                            <span className="text-lg leading-none mt-0.5">⚠️</span>
                            <p>{error}</p>
                        </div>
                    )}
                </div>

                {/* Result Display */}
                <div className="p-8 md:p-10 bg-slate-50 border-t border-slate-200 min-h-[450px]">
                    {!schedule && !loading ? (
                        <div className="text-center py-32 opacity-10">
                            <Icon name="trees" size={100} className="mx-auto mb-6" />
                            <p className="text-3xl font-black tracking-widest uppercase italic">Auto Planning Ready</p>
                        </div>
                    ) : schedule ? (
                        <div className="space-y-10 animate-slide-up">
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-2 mb-2 text-blue-400">
                                        <Icon name="cloud" size={14} />
                                        <span className="text-[10px] font-black uppercase tracking-widest">Weather (Rain)</span>
                                    </div>
                                    <p className="text-xl font-black text-blue-900">{Array.isArray(rainyDays) ? rainyDays.sort((a,b)=>a-b).join(', ') : rainyDays || '없음'}</p>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-2 mb-2 text-rose-400">
                                        <Icon name="calendar" size={14} />
                                        <span className="text-[10px] font-black uppercase tracking-widest">Holidays</span>
                                    </div>
                                    <p className="text-xl font-black text-rose-900">{Array.isArray(holidays) ? holidays.sort((a,b)=>a-b).join(', ') : holidays || '없음'}</p>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm hidden md:block">
                                    <div className="flex items-center gap-2 mb-2 text-emerald-500">
                                        <Icon name="bot" size={14} />
                                        <span className="text-[10px] font-black uppercase tracking-widest">AI Status</span>
                                    </div>
                                    <p className="text-xl font-black text-emerald-900">최적화 완료</p>
                                </div>
                            </div>

                            <div className="space-y-6">
                                {[
                                    { id: 'austria', name: '오스트리아', label: 'Austria', color: 'bg-rose-50 text-rose-800 border-rose-100' },
                                    { id: 'sweden', name: '스웨덴', label: 'Sweden', color: 'bg-amber-50 text-amber-800 border-amber-100' },
                                    { id: 'norway', name: '노르웨이', label: 'Norway', color: 'bg-sky-50 text-sky-800 border-sky-100' }
                                ].map(c => (
                                    <div key={c.id} className={`p-8 rounded-[3.5rem] border-2 ${c.color} flex flex-col md:flex-row md:items-center justify-between gap-8 transition-all hover:scale-[1.01] hover:shadow-xl`}>
                                        <div className="flex items-center gap-6">
                                            <div className="bg-white/60 p-5 rounded-3xl shadow-sm"><Icon name="trees" size={36} /></div>
                                            <div>
                                                <h3 className="text-4xl font-black tracking-tighter">{c.name}</h3>
                                                <p className="text-[11px] font-black uppercase opacity-40 tracking-[0.3em] mt-1 italic">Monthly Garden Care</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-4">
                                            {schedule[c.id] && schedule[c.id].length > 0 ? schedule[c.id].map((day, i) => (
                                                <div key={i} className="bg-white px-10 py-6 rounded-[2.5rem] shadow-md text-5xl font-black min-w-[130px] text-center border border-inherit border-opacity-30 flex flex-col items-center">
                                                    <span className="text-[11px] opacity-20 mb-2 font-black tracking-widest">{i+1}회</span>
                                                    {day}
                                                </div>
                                            )) : <span className="text-slate-400 font-black italic bg-white/40 px-10 py-7 rounded-[2.5rem] border-2 border-dashed border-slate-200 text-sm uppercase">Winter Break</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {sources.length > 0 && (
                                <div className="p-6 bg-white rounded-3xl border border-slate-200">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2 font-pretendard">
                                        <Icon name="sync" size={12} /> Data Grounding Sources
                                    </p>
                                    <div className="flex flex-wrap gap-2">
                                        {sources.map((s, idx) => (
                                            <a key={idx} href={s.uri} target="_blank" rel="noopener noreferrer" className="px-3 py-1 bg-slate-100 hover:bg-emerald-100 text-slate-500 hover:text-emerald-700 rounded-full text-[10px] font-bold transition-colors border border-slate-200 shadow-sm">
                                                {s.title?.length > 30 ? s.title.slice(0, 30) + "..." : s.title}
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : null}
                </div>
            </div>
            <footer className="mt-12 text-slate-400 text-[10px] font-black tracking-[0.5em] uppercase opacity-40 text-center leading-loose">
                Intelligent Garden Management Platform<br/>
                Optimized for Professional Landscapers
            </footer>
        </div>
    );
}
